---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "##",
  fig.path = "man/figures/"
)
options(digits = 4, width = 160)
```

# hmatch: Tools for cleaning and matching hierarchically-structured data
<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

An R package for cleaning and matching messy hierarchical data (e.g. hierarchically-nested adminstrative districts).


## Installation

Install from GitHub with:

```{r, eval=FALSE}
# install.packages("remotes")
remotes::install_github("epicentre-msf/hmatch")
```

### Usage

```{r}
library(hmatch)

# example datasets (select counties in northereastern North America)
data(ne_raw)
data(ne_ref)
```


#### Generate unique codes for each level in a reference dataset

Functions `hcodes_int()` and `hcodes_str()` can be used to create integer- or
string-based codes, respectively.

```{r}
ne_ref$hcode <- hcodes_int(ne_ref, pattern = "^adm")
ne_ref
```

#### Match messy hierarchically-structured data to a reference dataset

##### Exact matching

Each hierarchical level must match in sequence.

```{r}
hmatch_exact(ne_raw, ne_ref, type = "inner")
```

##### Partial matching

Allows for missing values at one or more level below the match level.

```{r}
hmatch_partial(ne_raw, ne_ref, type = "inner")
```

##### Partial + fuzzy matching

Partial matching + fuzzy matching based on the
[stringdist](https://github.com/markvanderloo/stringdist) package.

```{r}
hmatch_partial(ne_raw, ne_ref, type = "inner", fuzzy = TRUE, max_dist = 2)
```

##### Manual matching

Manually-specified matches, linking sets of hierarchical levels in the raw data
to a corresponding code column in the reference data.

```{r}
ne_man <- data.frame(adm0 = NA_character_,
                     adm1 = NA_character_,
                     adm2 = "NJ_Bergen",
                     hcode = "211",
                     stringsAsFactors = FALSE)

hmatch_manual(ne_raw, ne_ref, ne_man, code_col = "hcode", type = "inner")
```

##### Best-possible matching

Identify potential matches at each successive level, starting with only the
first level, then the first and second level, etc. The best-possible match then
reflects the highest-level that is consistent among all possible matches to the
given row of raw data.

```{r}
hmatch_best(raw = ne_raw, ref = ne_ref, fuzzy = TRUE)
```

##### The all-strategies approach

Implement all matching strategies in turn, from most to least strict:

1. (optional) manually-specified matching with `hmatch_manual()`
2. exact matching with `hmatch_exact()`
3. partial matching with `hmatch_partial()`
4. fuzzy partial matching with `hmatch_partial(..., fuzzy = TRUE)`
5. best-possible matching with `hmatch_best()`

```{r}
hmatch(raw = ne_raw, ref = ne_ref, man = ne_man, fuzzy = TRUE, code_col = "hcode")
```

